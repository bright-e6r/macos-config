name: Weekly Package Update

on:
  schedule:
    # 매주 월요일 새벽 2시 (한국시간) = 일요일 UTC 17시
    - cron: '0 17 * * 0'
  workflow_dispatch: # 수동 실행 가능

jobs:
  update-packages:
    name: Update Homebrew packages
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update Homebrew and upgrade packages
        run: |
          echo "Updating Homebrew..."
          brew update

          echo ""
          echo "Upgrading packages..."
          brew upgrade

          echo ""
          echo "Cleaning up..."
          brew cleanup

      - name: Generate updated Brewfile
        run: |
          echo "Generating updated Brewfile..."
          cd dotfiles/packages
          brew bundle dump --force

      - name: Show changes
        run: |
          echo "=== Changed files ==="
          git status --short

          if [ -n "$(git status --porcelain)" ]; then
            echo ""
            echo "=== Git diff ==="
            git diff
          else
            echo "No changes detected"
          fi

      - name: Create Pull Request
        if: github.event_name == 'schedule'
        uses: peter-evans/create-pull-request@v6
        with:
          title: "chore: weekly package update"
          body: |
            ## 패키지 자동 업데이트

            매주 월요일 새벽에 자동으로 Homebrew 패키지를 업데이트합니다.

            ### 변경된 내용

            - Homebrew 업데이트 및 패키지 업그레이드
            - Brewfile의 패키지 버전 정보 최신화

            ### 검토 포인트

            - 의도치 않은 패키지 추가/제거가 있는지 확인
            - 의존성 패키지 변경 사항 검토
            - 문제가 없으면 병합해 주세요

          branch: weekly-update
          delete-branch: true
          labels: automated
          commit-message: "chore: weekly package update"
