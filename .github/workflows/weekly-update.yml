name: Weekly Package Update

on:
  schedule:
    # 매주 월요일 새벽 2시 (한국시간) = 일요일 UTC 17시
    - cron: '0 17 * * 0'
  workflow_dispatch: # 수동 실행 가능

jobs:
  update-packages:
    name: Update Homebrew packages
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update Homebrew and upgrade packages
        run: |
          echo "Updating Homebrew..."
          brew update

          echo ""
          echo "Upgrading packages..."
          brew upgrade

          echo ""
          echo "Cleaning up..."
          brew cleanup

      - name: Generate updated Brewfile
        run: |
          echo "Generating updated Brewfile..."
          cd dotfiles/packages
          brew bundle dump --force

      - name: Show changes
        run: |
          echo "=== Changed files ==="
          git status --short

          if [ -n "$(git status --porcelain)" ]; then
            echo ""
            echo "=== Git diff ==="
            git diff
          else
            echo "No changes detected"
          fi

      - name: Create Pull Request
        if: github.event_name == 'schedule'
        uses: peter-evans/create-pull-request@v6
        with:
          title: "chore: weekly package update"
          body: |
            ## 패키지 자동 업데이트

            매주 월요일 새벽에 자동으로 Homebrew 패키지를 업데이트합니다.

            ### 변경된 내용

            - Homebrew 업데이트 및 패키지 업그레이드
            - Brewfile의 패키지 버전 정보 최신화

            ### 검토 포인트

            - 의도치 않은 패키지 추가/제거가 있는지 확인
            - 의존성 패키지 변경 사항 검토
            - 문제가 없으면 병합해 주세요

          branch: weekly-update
          delete-branch: true
          labels: automated
          commit-message: "chore: weekly package update"

  check-shell-scripting:
    name: Check Shell Scripting Best Practices
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install latest ShellCheck
        run: |
          echo "Installing latest ShellCheck..."
          brew install shellcheck

      - name: Auto-fix shell scripting best practices
        run: |
          echo "=== Checking Shell Scripts for Best Practices ==="
          echo ""

          CHANGES_MADE=0
          SUGGESTIONS=""

          # Check for using env in shebang (portability)
          echo "Checking shebangs..."
          for script in ./*.sh; do
            if [ -f "$script" ]; then
              FIRST_LINE=$(head -n 1 "$script")
              if [[ $FIRST_LINE == "#!/bin/bash" ]] && ! grep -q "# shellcheck disable=SC2001" "$script"; then
                if ! grep -q "#!/usr/bin/env bash" "$script"; then
                  sed -i '' '1s|#!/bin/bash|#!/usr/bin/env bash|' "$script"
                  echo "✓ Fixed: $script - shebang updated to '#!/usr/bin/env bash'"
                  CHANGES_MADE=$((CHANGES_MADE + 1))
                  SUGGESTIONS="${SUGGESTIONS}\\n- **$script**: Shebang updated to '#!/usr/bin/env bash' for better portability"
                fi
              fi
            fi
          done
          echo ""

          # Check for set -euo pipefail (error handling)
          echo "Checking error handling options..."
          for script in ./*.sh; do
            if [ -f "$script" ]; then
              if grep -q "set -e" "$script"; then
                if ! grep -q "set -euo pipefail" "$script"; then
                  sed -i '' 's|set -e$|set -euo pipefail|' "$script"
                  echo "✓ Fixed: $script - error handling upgraded to 'set -euo pipefail'"
                  CHANGES_MADE=$((CHANGES_MADE + 1))
                  SUGGESTIONS="${SUGGESTIONS}\\n- **$script**: Error handling upgraded to 'set -euo pipefail' for better error detection"
                fi
              fi
            fi
          done
          echo ""

          # Run ShellCheck and create report
          echo "Running ShellCheck..."
          SHELLCHECK_OUTPUT=$(mktemp)
          shellcheck --severity=warning ./*.sh 2>&1 | tee "$SHELLCHECK_OUTPUT" || true

          echo ""
          if [ $CHANGES_MADE -eq 0 ] && [ ! -s "$SHELLCHECK_OUTPUT" ]; then
            echo "✅ All shell scripts follow modern best practices!"
            exit 0
          else
            echo "ℹ️  Found improvements to apply"
          fi

      - name: Show changes
        if: github.event_name == 'schedule'
        run: |
          echo "=== Changed files ==="
          git status --short

          if [ -n "$(git status --porcelain)" ]; then
            echo ""
            echo "=== Git diff ==="
            git diff
          fi

      - name: Create improvement suggestions PR
        if: github.event_name == 'schedule'
        uses: peter-evans/create-pull-request@v6
        with:
          title: "chore: apply shell scripting best practices"
          body: |
            ## Shell 스크립팅 최신 관행 반영

            최신 Shell 스크립팅 관행에 따라 자동으로 코드 개선을 적용합니다.

            ### 자동 수정된 내용

            변경사항을 확인해주세요:
            - Shebang 포터빌리티: `#!/bin/bash` → `#!/usr/bin/env bash`
            - 에러 핸들링: `set -e` → `set -euo pipefail`
            - ShellCheck 권장사항 반영

            ### 검토 포인트

            - 자동 수정된 코드가 의도대로 동작하는지 확인
            - `set -euo pipefail`로 인해 스크립트가 너무 엄격해지지 않았는지 확인
            - 문제가 없으면 병합해 주세요

            ### 참고

            - 이 변경사항들은 최신 Bash 스크립팅 관행을 따르는 것입니다
            - `set -euo pipefail`는 파이프라인 실패 시 즉시 종료하여 버그를 예방합니다
            - `#!/usr/bin/env bash`는 다른 시스템에서의 포터빌리티를 향상시킵니다

          branch: shell-scripting-improvements
          delete-branch: true
          labels: automated,shellcheck
          commit-message: "chore: apply shell scripting best practices"
